<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Project WebGIS </title>
     <!-- Leaflet CSS -->
    <link rel="stylesheet" 
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
        crossorigin="" />
    <link rel="stylesheet" 
        href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css">
    <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    #map {
      position: absolute;
      top: 0; bottom: 0; left: 0; right: 0;
    }
    .icon {
      max-width: 70%;
      max-height: 70%;
      margin: 4px;
    }
    </style>
</head>
<body>
    <div id="map"></div>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
    crossorigin="">
    </script>
    <!-- FileLayer Plugin Lib -->
    <script src="https://unpkg.com/togeojson@0.14.2"></script>
    <script src="https://cdn.jsdelivr.net/gh/makinacorpus/Leaflet.FileLayer/leaflet.filelayer.js"></script>
    <!-- Other Needed Plugin/GeoJSON -->
    <script src="Tblock.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>
    <!-- Start Code Writing Here -->
    <script>
        var map = L.map('map').setView([-6.493053513471269, 108.31170522048976], 11);

        // QGIS
        var highlightLayer;
        function highlightFeature(e) {
            highlightLayer = e.target;

            if (e.target.feature.geometry.type === 'LineString' || e.target.feature.geometry.type === 'MultiLineString') {
              highlightLayer.setStyle({
                color: '#ffff00',
              });
            } else {
              highlightLayer.setStyle({
                fillColor: '#ffff00',
                fillOpacity: 1
              });
            }
        }

        // remove popup's row if "visible-with-data"
        function removeEmptyRowsFromPopupContent(content, feature) {
         var tempDiv = document.createElement('div');
         tempDiv.innerHTML = content;
         var rows = tempDiv.querySelectorAll('tr');
         for (var i = 0; i < rows.length; i++) {
             var td = rows[i].querySelector('td.visible-with-data');
             var key = td ? td.id : '';
             if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
                 rows[i].parentNode.removeChild(rows[i]);
             }
         }
         return tempDiv.innerHTML;
        }

        // add class to format popup if it contains media
        function addClassToPopupIfMedia(content, popup) {
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            if (tempDiv.querySelector('td img')) {
                popup._contentNode.classList.add('media');
                // Delay to force the redraw
                setTimeout(function() {
                    popup.update();
                }, 10);
            } else {
                popup._contentNode.classList.remove('media');
            }
        }

        function pop_Tblock(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    Tblock.resetStyle(e.target);
                },
                mouseover: highlightFeature,
            });
                var popupContent = '<table>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['bank'] !== null ? String(feature.properties['bank']).toLocaleString() : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['Canal_name'] !== null ? String(feature.properties['Canal_name']).toLocaleString() : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['Packages'] !== null ? String(feature.properties['Packages']).toLocaleString() : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['Nama_block'] !== null ? String(feature.properties['Nama_block']).toLocaleString() : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['Approval'] !== null ? String(feature.properties['Approval']).toLocaleString() : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['AreaMCIM'] !== null ? String(feature.properties['AreaMCIM']).toLocaleString() : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['Constructi'] !== null ? String(feature.properties['Constructi']).toLocaleString() : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['Cons_Type'] !== null ? String(feature.properties['Cons_Type']).toLocaleString() : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['Desa'] !== null ? String(feature.properties['Desa']).toLocaleString() : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['Kecamatan'] !== null ? String(feature.properties['Kecamatan']).toLocaleString() : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['KotaKab'] !== null ? String(feature.properties['KotaKab']).toLocaleString() : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['Contractor'] !== null ? String(feature.properties['Contractor']).toLocaleString() : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
            layer.on('popupopen', function(e) {
                addClassToPopupIfMedia(content, e.popup);
            });
            layer.bindPopup(content, { maxHeight: 400 });
        }

        // Tertiary Block Variable
        var Tblock = L.geoJSON(tblock, { style: style_tblock, onEachFeature: pop_Tblock }).addTo(map);

        function style_tblock(json) {
            var att = json.properties;
            var type = att.Cons_Type;
            var color, fill_color, fill_opacity = 0.3;

            switch (att.RepVis) {
              case 'District Authority':
                color = '#973C08'; fill_color = '#973C08'; break;
              case 'MDA':
                color = '#432DD7'; fill_color = '#432DD7'; break;
              case 'No Construction':
                color = '#E7180B'; fill_color = '#E7180B'; break;
              case 'Ready':
                color = '#FE9A37'; fill_color = '#FE9A37'; break;
              case 'Remaining':
                color = '#F1F5F9'; fill_color = '#F1F5F9'; break;
              case 'Under Construction':
                if (type === 'Precast') {
                  color = '#46ECD5'; fill_color = '#46ECD5';
                } else if (type === 'Insitu') {
                  color = '#FFF085'; fill_color = '#FFF085';
                }
                break;
              default:
                color = 'black'; fill_color = 'black'; break;
            }

            return {
              color: color,
              fillColor: fill_color,
              fillOpacity: fill_opacity,
              weight: 1
            };
        }

        // Basemap Variable
        var maptiler = L.tileLayer('https://api.maptiler.com/maps/hybrid/{z}/{x}/{y}.jpg?key=W6d5CfR5JVewAHeVqQzP', {
            attribution: '<a href="https://www.maptiler.com/copyright/" target="_blank">&copy; MapTiler</a> <a href="https://www.openstreetmap.org/copyright" target="_blank">&copy; OpenStreetMap contributors</a>',
        }).addTo(map);

        var esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        });

        var osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        });

        var darkmap = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 20
        });

        // Leaflet Layer Control
        var basemaps = {
            'Satellite Imagery': maptiler,
            'Open Street Map': osm,
            'ESRI World Imagery': esri,
            'Carto Dark Map': darkmap
        }

        L.control.layers(basemaps).addTo(map);

        // FileLayer Upload
        var style = {
          color: 'red',
          opacity: 1.0,
          fillOpacity: 0.6,
          weight: 2,
          interactive: false
        };

        L.Control.FileLayerLoad.LABEL = '<img class="icon" src="https://static.thenounproject.com/png/folder-icon-652750-512.png" alt="file icon"/>';
        var fileLayerControl = L.Control.fileLayerLoad({
          fitBounds: true,
          layerOptions: {
            style: style,
            pointToLayer: function (data, latlng) {
              return L.circleMarker(latlng, style);
            }
          }
        });
        fileLayerControl.addTo(map);

        // Log loaded file data
        fileLayerControl.loader.on('data:loaded', function (e) {
          console.log("Loaded layer:", e.layer);
        });
    </script>
</body>
</html>
