<!DOCTYPE html>
<html lang="en">
    <select id="packageFilter" style="
        position:absolute;
        top:12rem;
        right:1rem;
        z-index:4000;
        padding:0.4rem;
        border-radius:0.3rem;
        font-size: 0.8rem;
    ">
        <option value="ALL">All Packages</option>
        <option value="LOS-01">LOS-01</option>
        <option value="LOS-02">LOS-02</option>
        <option value="LOS-03">LOS-03</option>
        <option value="LOS-04">LOS-04</option>
    </select>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WEBGIS MONITORING RIMP</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin="" />
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css">
    <style>
    html, body { height: 100%; margin: 0; } 
    #map { position: absolute;inset:0;  } 
    .icon { max-width: 70%; max-height: 70%; margin: 0.3rem; }

    /* Info panel table styling */
    #info-panel table { 
        width: 100%; 
        border-collapse: collapse; 
        font-family: Arial, sans-serif;
        font-size: 13px;
        line-height: 1.4;
        color: #333;
    }
    #info-panel th, #info-panel td {
        padding: 6px;
        border: 1px solid #ddd;
    }
    #info-panel th { 
        background-color: #f7f7f7; 
        font-weight: bold; 
        text-align: left; 
        width: 40%; 
    }
    #info-panel td { background-color: #ffffff; }

/* ---------- Legend Container ---------- */
.leaflet-control.legend {
    position: fixed;
    left: 50%;
    bottom: 20px;
    transform: translateX(-50%);
    background: white;
    padding: 10px 14px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.25);
    font-size: 12px;
    z-index: 1000;
    max-width: 90vw;
}

/* ---------- Legend Title ---------- */
.legend-title {
    text-align: center;
    font-weight: bold;
    margin-bottom: 8px;
}

/* ---------- Legend Items (2 rows layout) ---------- */
.legend {
    display: grid;
    grid-template-columns: repeat(4, auto); /* 8 items â†’ 2 rows */
    gap: 6px 14px;
}

/* ---------- Individual Item ---------- */
.legend .item {
    display: flex;
    align-items: center;
    white-space: wrap;
}

/* ---------- Color Box ---------- */
.legend .swatch {
    width: 14px;
    height: 14px;
    margin-right: 6px;
    border: 1px solid #999;
}
    /* Label styling */
    #label {
        font-family: Cambria, Cochin, Georgia, Times, 'Times New Roman', serif;
        font-size: clamp(1rem, 2.5vw, 1.4rem);
        position: absolute;
        top: 1rem;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(255, 255, 255, 1);
        padding: 0.5rem 0.75rem;
        border-radius: 0.5rem;
        z-index: 1000;
    }

    /* Logo styling for responsiveness */
    .logo-nippon {
        background-color: rgba(255, 255, 255, 1);
        position: absolute;
        top: 1rem;
        z-index: 2000;
        width: clamp(96px, 16vw, 150px);
        height: auto;        /* maintain aspect ratio */
    }
        .logo {
        position: absolute;
        top: 1rem;
        z-index: 2000;
        width: clamp(48px, 8vw, 90px);
        height: auto;        /* maintain aspect ratio */
    }
    #logo-left { left: 5rem; }
    #logo-right { right: 12rem; }
    /* ---------- Mobile Optimization ---------- */
    @media (max-width: 768px) {
        #dashboard {
            top: auto;
            bottom: 6.5rem;
            right: 50%;
            transform: translateX(50%);
        }

        #info-panel {
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
        }
    }
    </style>
</head>
<body>
    <div id="map"></div>

    <div id="label">RENTANG IRRIGATION MODERNIZATION PROJECT (RIMP IP-573)</div>

    <img id="logo-left" class="logo" src="pupr.png" alt="Left Logo">
    <img id="logo-right" class="logo-nippon" src="nippon.png" alt="Right Logo">

    <div id="info-panel" style="
        position:absolute;
        bottom:1rem;
        left:1rem;
        width:min(90vw, 320px);
        background:white;
        padding:0.6rem;
        border-radius:0.5rem;
        z-index:3000;
        max-height: 45vh;
        overflow-y: auto;">
        Click a feature to see info
    </div>
    <div id="dashboard" style="
        position:absolute;
        top:15rem;
        right:1rem;
        z-index:4000;
        width:min(90vw, 280px);
        background:white;
        padding:0.6rem;
        border-radius:0.5rem;
        font-family:Arial, sans-serif;
        font-size:0.75rem;
        box-shadow:0 0 6px rgba(0,0,0,0.25);
        max-height: 50vh;
        overflow-y: auto;
    ">
        <strong>Monitoring Dashboard</strong>
        <hr style="margin:6px 0">

        <div><strong>Left Bank Area</strong></div>
        <div id="stat-des-appr"></div>

        <hr style="margin:6px 0">

        <div><strong>Construction Status</strong></div>
        <div id="stat-cons-stat"></div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script src="https://unpkg.com/togeojson@0.14.2"></script>
    <script src="https://cdn.jsdelivr.net/gh/makinacorpus/Leaflet.FileLayer/leaflet.filelayer.js"></script>
    <script src="Tblock.js"></script>
    <script src="Structures.js"></script>
    <script src="Tcanal.js"></script>
    <script src="canal.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>

    <script>
    // Map initialization
    var map = L.map('map').setView([-6.493053513471269, 108.31170522048976], 11);

    // Highlight helpers
    var lastHighlight = null;
    function highlightFeature(e) {
        var layer = e.target;
        if (!layer._originalStyle && layer.setStyle) {
            layer._originalStyle = {
                color: layer.options.color,
                weight: layer.options.weight,
                fillColor: layer.options.fillColor,
                fillOpacity: layer.options.fillOpacity
            };
        }

        if (layer.feature && layer.feature.geometry && 
            (layer.feature.geometry.type === 'LineString' || layer.feature.geometry.type === 'MultiLineString')) {
            if (layer.setStyle) layer.setStyle({ color: '#ffff00', weight: (layer._originalStyle && layer._originalStyle.weight ? layer._originalStyle.weight + 1 : 3) });
        } else {
            if (layer.setStyle) layer.setStyle({ fillColor: '#ffff00', fillOpacity: 1 });
        }
        lastHighlight = layer;
    }
    function resetHighlight(e) {
        var layer = e.target || lastHighlight;
        if (!layer) return;
        if (layer.setStyle && layer._originalStyle) {
            layer.setStyle(layer._originalStyle);
        }
        lastHighlight = null;
    }

    // Utility to remove empty rows
    function removeEmptyRowsFromPopupContent(content, feature) {
        var tempDiv = document.createElement('div');
        tempDiv.innerHTML = content;
        var rows = tempDiv.querySelectorAll('tr');
        for (var i = rows.length - 1; i >= 0; i--) {
            var td = rows[i].querySelector('td');
            if (!td) continue;
            var text = td.textContent || '';
            if (text.trim() === '' || text === 'null' || text === 'undefined') {
                rows[i].parentNode.removeChild(rows[i]);
            }
        }
        return tempDiv.innerHTML;
    }

    // ---------- Popup functions converted to static info panel ----------
    function pop_Tblock(feature, layer) {
        layer.on({
            click: function () {
                let p = feature.properties;
                document.getElementById("info-panel").innerHTML = `
                <table>
                    <tr><th>Remarks</th><td>${p.REMARKS ?? ''}</td></tr>
                    <tr><th>Bank</th><td>${p.BANK ?? ''}</td></tr>
                    <tr><th>Canal Name</th><td>${p.CANAL ?? ''}</td></tr>
                    <tr><th>Packages</th><td>${p.PACKAGES ?? ''}</td></tr>
                    <tr><th>Block Name</th><td>${p.TB_NAME ?? ''}</td></tr>
                    <tr><th>Approval</th><td>${p.DES_APPR ?? ''}</td></tr>
                    <tr><th>Area</th><td>${p.AREA_HA ?? ''} Ha</td></tr>
                    <tr><th>Construction</th><td>${p.CONS_STAT ?? ''}</td></tr>
                    <tr><th>Construction Type</th><td>${p.CONS_TYPE ?? ''}</td></tr>
                    <tr><th>Desa</th><td>${p.VILLAGE ?? ''}</td></tr>
                    <tr><th>Kecamatan</th><td>${p.SUB_DIST ?? ''}</td></tr>
                    <tr><th>Kota/Kab</th><td>${p.DISTRICT ?? ''}</td></tr>
                    <tr><th>Contractor</th><td>${p.CONTRACTOR ?? ''}</td></tr>
                </table>`;
                highlightFeature({target: layer});
            },
            mouseover: highlightFeature,
            mouseout: resetHighlight
        });
    }

    function pop_Box(feature, layer) {
        layer.on({
            click: function () {
                let p = feature.properties;
                document.getElementById("info-panel").innerHTML = `
                <table>
                    <tr><th>Key</th><td>${p.Key ?? ''}</td></tr>
                    <tr><th>Tertiary Block</th><td>${p.Nama_block ?? ''}</td></tr>
                    <tr><th>Nama Box</th><td>${p.Nama_Box ?? ''}</td></tr>
                </table>`;
                highlightFeature({target: layer});
            },
            mouseover: highlightFeature,
            mouseout: resetHighlight
        });
    }

    function pop_Tertiary(feature, layer) {
        layer.on({
            click: function () {
                let p = feature.properties;
                document.getElementById("info-panel").innerHTML = `
                <table>
                    <tr><th>Section</th><td>${p.Con_Name ?? ''}</td></tr>
                    <tr><th>Length</th><td>${p.Length ?? ''} m</td></tr>
                    <tr><th>Type</th><td>${p.canal_type ?? ''}</td></tr>
                    <tr><th>Tertiary Block</th><td>${p.Nama_block ?? ''}</td></tr>
                </table>`;
                highlightFeature({target: layer});
            },
            mouseover: highlightFeature,
            mouseout: resetHighlight
        });
    }

        function pop_Canal(feature, layer) {
        layer.on({
            click: function () {
                let p = feature.properties;
                document.getElementById("info-panel").innerHTML = `
                <table>
                    <tr><th>Tertiary Block</th><td>${p.Package ?? ''}</td></tr>
                    <tr><th>Section</th><td>${p.Canal_name ?? ''}</td></tr>
                    <tr><th>Length</th><td>${p.length_m ?? ''} m</td></tr>
                    <tr><th>Type</th><td>${p.Canal_type ?? ''}</td></tr>
                </table>`;
                highlightFeature({target: layer});
            },
            mouseover: highlightFeature,
            mouseout: resetHighlight
        });
    }

    // ---------- Styles ----------
    function style_tblock(feature) {
        var att = feature.properties || {};
        var type = att.CONS_TYPE;
        var color = 'black', fill_color = 'black', fill_opacity = 0.4;

        switch (att.CONS_STAT) {
          case 'District Authority': color = '#a83800'; fill_color = '#a83800'; break;
          case 'MDA': color = '#432DD7'; fill_color = '#432DD7'; break;
          case 'No Construction': color = '#e60000'; fill_color = '#e60000'; break;
          case 'Ready':
            if (type === 'Precast') { color = '#ffaa00'; fill_color = '#ffaa00'; }
            else if (type === 'Insitu') { color = '#ffff00'; fill_color = '#ffff00'; } 
            break;
          case 'Remaining': color = '#F1F5F9'; fill_color = '#F1F5F9'; break;
          case 'Under Construction':
            if (type === 'Precast') { color = '#00ffc5'; fill_color = '#00ffc5'; }
            else if (type === 'Insitu') { color = '#55ff00'; fill_color = '#55ff00'; }
            break;
        }
        return { color: color, fillColor: fill_color, fillOpacity: fill_opacity, weight: 1 };
    }

    function style_box(feature) {
        var att = feature.properties || {};
        var style = { radius: 6, fillOpacity: 0.9, weight: 1, color: '#333', fillColor: '#ff7800' };
        switch (att.LAYER) {
            case 'Box Tersier': style.color = 'brown'; style.fillColor = 'brown'; break;
            case 'Box Kuarter': style.color = 'blue'; style.fillColor = 'blue'; break;
            case 'Box Division': style.color = 'red'; style.fillColor = 'red'; break;
            case 'Culvert': style.color = 'purple'; style.fillColor = 'purple'; break;
        }
        return style;
    }

    function style_tertiary(feature) {
        var att = feature.properties || {};
        var color = '#0077be';
        switch (att.Connection) {
        case 'OT-T': color = '#eb2bf2'; break;
        case 'OT-K': color = '#43f17a'; break;
        case 'T-T': color = '#54d7ab'; break;
        case 'T-K': color = '#fcf239'; break;
        case 'K-END': color = '#62c849'; break;
        }
        return { color: color, weight: 2 };
    }

        function style_canal(feature) {
        var att = feature.properties || {};
        var color = '#0077be';
        switch (att.Canal_type) {
        case 'Main Canal': color = '#092af0', weight = 5; break;
        case 'Secondary Canal': color = '#11aed9', weight = 3; break;
        case 'Drainage Canal': color = '#ff001b', weight = 3; break;
        }
        return { color: color, weight: weight };
    }

    // ---------- Layers ----------
    var Tblock = L.geoJSON(typeof Tblock !== 'undefined' ? Tblock : [], { style: style_tblock, onEachFeature: pop_Tblock }).addTo(map);
    var boxLayer = L.geoJSON(typeof boxLayer !== 'undefined' ? boxLayer : [], {
        pointToLayer: function(feature, latlng) { return L.circleMarker(latlng, style_box(feature)); },
        onEachFeature: pop_Box
    });
    var tertiaryLayer = L.geoJSON(typeof tertiaryLayer !== 'undefined' ? tertiaryLayer : [], { style: style_tertiary, onEachFeature: pop_Tertiary });
    var canal = L.geoJSON(typeof canal !== 'undefined' ? canal : [], { style: style_canal, onEachFeature: pop_Canal }).addTo(map);
    // ---------- Basemaps ----------
    var maptiler = L.tileLayer('https://api.maptiler.com/maps/hybrid/{z}/{x}/{y}.jpg?key=W6d5CfR5JVewAHeVqQzP', { attribution: '<a href="https://www.maptiler.com/copyright/" target="_blank">&copy; MapTiler</a> <a href="https://www.openstreetmap.org/copyright" target="_blank">&copy; OpenStreetMap contributors</a>' }).addTo(map);
    var esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles &copy; Esri' });
    var osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap contributors' });
    var darkmap = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { subdomains: 'abcd', maxZoom: 20 });
    var basemaps = { 'Satellite Imagery': maptiler, 'Open Street Map': osm, 'ESRI World Imagery': esri, 'Carto Dark Map': darkmap };
    var overlays = {'Structures': boxLayer, 'Tertiary Canals': tertiaryLayer, 'Tertiary Blocks': Tblock};
    L.control.layers(basemaps, overlays, { collapsed: true }).addTo(map);

    // ---------- Center Map Control Button ----------
    var CenterControl = L.Control.extend({
        options: {
            position: 'topleft' // Position the button
        },

        onAdd: function (map) {
            var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
            container.style.backgroundColor = 'white';
            container.style.width = '30px';
            container.style.height = '30px';
            container.style.lineHeight = '30px';
            container.style.textAlign = 'center';
            container.title = 'Zoom to Full Extent';
            container.innerHTML = `
                <div style="
                display: flex;
                align-items: center;
                justify-content: center;
                width: 100%;
                height: 100%;
            ">
                <img src="center.png" style="
                width: 20px;
                height: 20px;
                ">`;

            container.onclick = function(){
                fitToAllLayers();
            }

            return container;
        }
    });
    map.addControl(new CenterControl());
    // ---------- Legend ----------
    var legend = L.control({ position: 'bottomleft' });
    legend.onAdd = function(map) {
    var div = L.DomUtil.create('div', 'legend');

    div.innerHTML = `
        <div class="legend">
            ${[
                ['District Authority', '#a83800'],
                ['MDA', '#432DD7'],
                ['No Construction', '#e60000'],
                ['Ready - Precast', '#ffaa00'],
                ['Ready - Insitu', '##ffff00'],
                ['Remaining', '#F1F5F9'],
                ['Under Construction - Precast', '#00ffc5'],
                ['Under Construction - Insitu', '#55ff00']
            ].map(it => `
                <div class="item">
                    <span class="swatch" style="background:${it[1]}"></span>
                    <span>${it[0]}</span>
                </div>
            `).join('')}
        </div>
    `;

    return div;
};

    legend.addTo(map);

    // ---------- FileLayer Upload ----------
    var fileLayerStyle = { color: 'red', opacity: 1.0, fillOpacity: 0.6, weight: 2, interactive: false };
    L.Control.FileLayerLoad.LABEL = '<img class="icon" src="https://static.thenounproject.com/png/folder-icon-652750-512.png" alt="file icon"/>';
    var fileLayerControl = L.Control.fileLayerLoad({ fitBounds: true, layerOptions: { style: fileLayerStyle, pointToLayer: function (data, latlng) { return L.circleMarker(latlng, fileLayerStyle); } } });
    fileLayerControl.addTo(map);
    fileLayerControl.loader.on('data:loaded', function (e) { console.log('Loaded layer:', e.layer); });

    // ---------- Fit map to visible data bounds ----------
    function fitToAllLayers() {
        var group = L.featureGroup();
        [Tblock, boxLayer, tertiaryLayer].forEach(function(l){ if (l && l.getBounds && l.getBounds().isValid && l.getBounds().isValid()) { try { group.addLayer(l); } catch(e){} } });
        try { var b = group.getBounds(); if (b && b.isValid()) map.fitBounds(b); } catch(e) {}
    }
    setTimeout(fitToAllLayers, 800);
    // ---------- Filter by PACKAGES ----------
document.getElementById("packageFilter").addEventListener("change", function () {
    var selected = this.value;
function zoomToFilteredPackages(selectedPackage) {
    var bounds = L.latLngBounds([]);

    Tblock.eachLayer(function (layer) {
        var p = layer.feature.properties;

        if (selectedPackage === "ALL" || p.PACKAGES === selectedPackage) {
            bounds.extend(layer.getBounds());
        }
    });

    if (bounds.isValid()) {
        map.fitBounds(bounds, {
            padding: [30, 30],
            maxZoom: 16
        });
    }
}
    //---------- Tblock ----------
    Tblock.eachLayer(function (layer) {
        var pkg = layer.feature.properties.PACKAGES;
        var show = (selected === "ALL" || pkg === selected);

        layer.setStyle({
            opacity: show ? 1 : 0,
            fillOpacity: show ? 0.4 : 0
        });
    });
    // ---------- Structures ----------
    boxLayer.eachLayer(function (layer) {
        var pkg = layer.feature.properties.Packages;
        var show = (selected === "ALL" || pkg === selected);

        layer.setStyle({
            opacity: show ? 1 : 0,
            fillOpacity: show ? 0.9 : 0
        });
    });
    // ---------- Tcanal ----------
    tertiaryLayer.eachLayer(function (layer) {
        var pkg = layer.feature.properties.Packages;
        var show = (selected === "ALL" || pkg === selected);

        layer.setStyle({
            opacity: show ? 1 : 0
        });
    });

    // Zoom Packages
    zoomToFilteredPackages(selected);
    // ðŸ”¹ Update dashboard
    updateDashboard(selected);
});
// ---------- Dashboard Counter ----------
function updateDashboard(selectedPackage = "ALL") {
    var areaTotal = 0;
    var lengthTotal = 0;

    var areaByCan = {};
    var lengthByCan = {};

    var consStatCount = {};

    Tblock.eachLayer(function (layer) {
        var p = layer.feature.properties;

        // Skip if package does not match
        if (selectedPackage !== "ALL" && p.PACKAGES !== selectedPackage) return;

        var area = parseFloat(p.AREA_HA) || 0;
        var length = (parseFloat(p.LENGTH_M) || 0) / 1000;

        areaTotal += area;
        lengthTotal += length;

        // Group by CANAL when a specific package is selected
        if (selectedPackage !== "ALL") {
            var can = p.CANAL || "Unknown";

            areaByCan[can] = (areaByCan[can] || 0) + area;
            lengthByCan[can] = (lengthByCan[can] || 0) + length;
        }

        // CONS_STAT always counted
        var stat = p.CONS_STAT || "Unknown";
        consStatCount[stat] = (consStatCount[stat] || 0) + 1;
    });

    /* ---------- Render AREA + LENGTH ---------- */
    var html = "";

    if (selectedPackage === "ALL") {
        html = `
            <div><strong>Total Area:</strong> ${formatNumber(areaTotal, 2)} Ha</div>
            <div><strong>Total Length:</strong> ${formatNumber(lengthTotal, 2)} Km</div>
        `;
    } else {
        for (var k in areaByCan) {
            html += `
                <div>
                    <strong>${k}</strong><br>
                    Area: ${formatNumber(areaByCan[k], 2)} Ha<br>
                    Length: ${formatNumber(lengthByCan[k], 2)} Km
                </div>
                <hr style="margin:4px 0">
            `;
        }
    }

    document.getElementById("stat-des-appr").innerHTML = html || "-";

    /* ---------- Render Construction Status ---------- */
    var statHtml = "";
    for (var k in consStatCount) {
        statHtml += `<div>${k}: <strong>${consStatCount[k]}</strong></div>`;
    }
    document.getElementById("stat-cons-stat").innerHTML = statHtml || "-";
}
// ---------- Number formatter ----------
function formatNumber(value, decimals = 2) {
    const n = Number(value) || 0;
    return n.toLocaleString('en-US', {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
    });
}
    // Initial load
    updateDashboard();

    </script>
</body>
</html>
