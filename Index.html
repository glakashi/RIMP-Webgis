<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project WebGIS</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin="" />
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css">

    <style>
    html, body { height: 100%; margin: 0; }
    #map { position: absolute; top: 0; bottom: 0; left: 0; right: 0; }
    .icon { max-width: 70%; max-height: 70%; margin: 4px; }

    /* Popup Styling */
    .leaflet-popup-content {
        font-family: Arial, sans-serif;
        font-size: 13px;
        line-height: 1.4;
        color: #333;
        margin: 0;
        max-width: 320px;
    }
    .leaflet-popup-content table {
        width: 100%;
        border-collapse: collapse;
    }
    .leaflet-popup-content th,
    .leaflet-popup-content td {
        padding: 4px 6px;
        border: 1px solid #ddd;
    }
    .leaflet-popup-content th {
        background: #f7f7f7;
        font-weight: bold;
        text-align: left;
        width: 40%;
    }
    .leaflet-popup-content td {
        background: #fff;
    }

    /* âœ… Static Info Panel Table Styling */
    #info-panel table {
        width: 100%;
        border-collapse: collapse;
        font-family: Arial, sans-serif;
        font-size: 13px;
        color: #333;
    }
    #info-panel th, #info-panel td {
        padding: 4px 6px;
        border: 1px solid #ddd;
    }
    #info-panel th {
        background: #f7f7f7;
        font-weight: bold;
        text-align: left;
        width: 40%;
    }
    #info-panel td {
        background: #fff;
    }

    /* Legend styling */
    .legend {
        background: white;
        padding: 8px;
        border-radius: 4px;
        box-shadow: 0 0 6px rgba(0,0,0,0.2);
    }
    .legend .item {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 4px;
    }
    .legend .swatch {
        width: 18px;
        height: 14px;
        border: 1px solid #ccc;
    }
    </style>
</head>

<body>
    <div id="map"></div>

    <div id="label" style="
        font-family:Cambria, Cochin, Georgia, Times, 'Times New Roman', serif;
        font-size: 20pt;
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(255, 255, 255, 1);
        padding: 5px;
        border-radius: 5px;
        z-index: 1000;">
        WEBGIS RENTANG IRRIGATION MODERNIZATION PROJECT
    </div>

    <img id="logo-left" src="pupr.png" alt="Left Logo" style="
        height: 60px;
        position: absolute;
        top: 10px;
        left: 200px;
        z-index: 2000;">
    <img id="logo-right" src="nippon.png" alt="Right Logo" style="
        height: 60px;
        position: absolute;
        top: 10px;
        right: 200px;
        z-index: 2000;">

    <div id="info-panel" style="
        position:absolute;
        bottom:20px;
        left:20px;
        width:300px;
        background:white;
        padding:10px;
        border-radius:6px;
        z-index:3000;">
        Click a feature to see info
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

    <script src="https://unpkg.com/togeojson@0.14.2"></script>
    <script src="https://cdn.jsdelivr.net/gh/makinacorpus/Leaflet.FileLayer/leaflet.filelayer.js"></script>
    <script src="Tblock.js"></script>
    <script src="Global_Box.js"></script>
    <script src="Global_Tertiary.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>

    <script>
    var map = L.map('map').setView([-6.493053513471269, 108.31170522048976], 11);

    var lastHighlight = null;
    function highlightFeature(e) {
        var layer = e.target;
        if (!layer._originalStyle && layer.setStyle) {
            layer._originalStyle = {
                color: layer.options.color,
                weight: layer.options.weight,
                fillColor: layer.options.fillColor,
                fillOpacity: layer.options.fillOpacity
            };
        }
        if (layer.feature.geometry.type.includes('Line')) {
            layer.setStyle({ color: '#ffff00', weight: 3 });
        } else {
            layer.setStyle({ fillColor: '#ffff00', fillOpacity: 1 });
        }
        lastHighlight = layer;
    }
    function resetHighlight() {
        if (lastHighlight && lastHighlight._originalStyle) {
            lastHighlight.setStyle(lastHighlight._originalStyle);
        }
        lastHighlight = null;
    }

    /* --- Static Info Panel Click Handlers --- */
    function pop_Tblock(feature, layer) {
        layer.on({
            click: () => {
                let p = feature.properties;
                document.getElementById("info-panel").innerHTML = `
                <table>
                    <tr><th>Bank</th><td>${p.bank ?? ''}</td></tr>
                    <tr><th>Canal Name</th><td>${p.Canal_name ?? ''}</td></tr>
                    <tr><th>Packages</th><td>${p.Packages ?? ''}</td></tr>
                    <tr><th>Block Name</th><td>${p.Nama_block ?? ''}</td></tr>
                    <tr><th>Approval</th><td>${p.Approval ?? ''}</td></tr>
                    <tr><th>Area</th><td>${p.AreaMCIM ?? ''}</td></tr>
                    <tr><th>Construction</th><td>${p.Constructi ?? ''}</td></tr>
                    <tr><th>Construction Type</th><td>${p.Cons_Type ?? ''}</td></tr>
                    <tr><th>Desa</th><td>${p.Desa ?? ''}</td></tr>
                    <tr><th>Kecamatan</th><td>${p.Kecamatan ?? ''}</td></tr>
                    <tr><th>Kota/Kab</th><td>${p.KotaKab ?? ''}</td></tr>
                    <tr><th>Contractor</th><td>${p.Contractor ?? ''}</td></tr>
                </table>`;
                highlightFeature({ target: layer });
            },
            mouseover: highlightFeature,
            mouseout: resetHighlight
        });
    }

    function pop_Box(feature, layer) {
        layer.on({
            click: () => {
                let p = feature.properties;
                document.getElementById("info-panel").innerHTML = `
                <table>
                    <tr><th>Key</th><td>${p.Key ?? ''}</td></tr>
                    <tr><th>Tertiary Block</th><td>${p.Nama_block ?? ''}</td></tr>
                    <tr><th>Nama Box</th><td>${p.Nama_Box ?? ''}</td></tr>
                </table>`;
                highlightFeature({ target: layer });
            },
            mouseover: highlightFeature,
            mouseout: resetHighlight
        });
    }

    function pop_Tertiary(feature, layer) {
        layer.on({
            click: () => {
                let p = feature.properties;
                document.getElementById("info-panel").innerHTML = `
                <table>
                    <tr><th>Section</th><td>${p.Con_name ?? ''}</td></tr>
                    <tr><th>Length</th><td>${p.Length ?? ''}</td></tr>
                    <tr><th>Type</th><td>${p.canal_type ?? ''}</td></tr>
                    <tr><th>Tertiary Block</th><td>${p.Nama_block ?? ''}</td></tr>
                </table>`;
                highlightFeature({ target: layer });
            },
            mouseover: highlightFeature,
            mouseout: resetHighlight
        });
    }

    /* Styles */
    function style_tblock(feature) {
        var att = feature.properties || {};
        var type = att.Cons_Type;
        var color = 'black', fill_color = 'black';

        switch (att.RepVis) {
          case 'District Authority': color = fill_color = '#973C08'; break;
          case 'MDA': color = fill_color = '#432DD7'; break;
          case 'No Construction': color = fill_color = '#E7180B'; break;
          case 'Ready': color = fill_color = '#FE9A37'; break;
          case 'Remaining': color = fill_color = '#F1F5F9'; break;
          case 'Under Construction':
            if (type === 'Precast') color = fill_color = '#46ECD5';
            if (type === 'Insitu') color = fill_color = '#FFF085';
            break;
        }
        return { color, fillColor: fill_color, fillOpacity: 0.3, weight: 1 };
    }

    function style_box(feature) {
        var att = feature.properties || {};
        var style = { radius: 6, fillOpacity: 0.9, weight: 1, color: '#333', fillColor: '#ff7800' };
        switch (att.LAYER) {
            case 'Box Tersier': style.color = style.fillColor = 'brown'; break;
            case 'Box Kuarter': style.color = style.fillColor = 'blue'; break;
            case 'Box Division': style.color = style.fillColor = 'red'; break;
            case 'Culvert': style.color = style.fillColor = 'purple'; break;
        }
        return style;
    }

    function style_tertiary(feature) {
        var att = feature.properties || {};
        var color = '#0077be';
        switch (att.Connection) {
          case 'OT-T': color = '#2a7ad6'; break;
          case 'OT-K': color = '#43f17a'; break;
          case 'T-T': color = '#6f2ed8'; break;
          case 'T-K': color = '#54d7ab'; break;
          case 'K-END': color = '#88170b'; break;
        }
        return { color, weight: 2 };
    }

    var Tblock = L.geoJSON(tblock, { style: style_tblock, onEachFeature: pop_Tblock }).addTo(map);
    var boxLayer = L.geoJSON(boxLayer, {
        pointToLayer: (f, ll) => L.circleMarker(ll, style_box(f)),
        onEachFeature: pop_Box
    }).addTo(map);
    var tertiaryLayer = L.geoJSON(tertiaryLayer, { style: style_tertiary, onEachFeature: pop_Tertiary }).addTo(map);

    var maptiler = L.tileLayer('https://api.maptiler.com/maps/hybrid/{z}/{x}/{y}.jpg?key=W6d5CfR5JVewAHeVqQzP').addTo(map);
    var osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png');
    var esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
    var darkmap = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png');

    L.control.layers({
        'Satellite Imagery': maptiler,
        'Open Street Map': osm,
        'ESRI World Imagery': esri,
        'Carto Dark Map': darkmap
    }, {
        'Tertiary Blocks': Tblock,
        'Boxes': boxLayer,
        'Tertiary Canals': tertiaryLayer
    }, { collapsed: false }).addTo(map);

    var legend = L.control({ position: 'bottomright' });
    legend.onAdd = () => {
        var div = L.DomUtil.create('div', 'legend');
        var items = [
            ['District Authority', '#973C08'],
            ['MDA', '#432DD7'],
            ['No Construction', '#E7180B'],
            ['Ready', '#FE9A37'],
            ['Remaining', '#F1F5F9'],
            ['Under Construction - Precast', '#46ECD5'],
            ['Under Construction - Insitu', '#FFF085']
        ];
        div.innerHTML += '<strong>Progress Status</strong><br/>';
        items.forEach(it => {
            div.innerHTML += `
                <div class="item">
                    <div class="swatch" style="background:${it[1]}"></div>
                    <div>${it[0]}</div>
                </div>`;
        });
        return div;
    };
    legend.addTo(map);

    setTimeout(() => {
        try {
            var group = L.featureGroup([Tblock, boxLayer, tertiaryLayer]);
            map.fitBounds(group.getBounds());
        } catch (e) {}
    }, 800);
    </script>
</body>
</html>
