<!DOCTYPE html>
<html lang="en">
    <select id="packageFilter" style="
        position:absolute;
        top:200px;
        right:20px;
        z-index:4000;
        padding:6px;
        border-radius:4px;
    ">
        <option value="ALL">All Packages</option>
        <option value="LOS-01">LOS-01</option>
        <option value="LOS-02">LOS-02</option>
        <option value="LOS-03">LOS-03</option>
        <option value="LOS-04">LOS-04</option>
    </select>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project WebGIS</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin="" />
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css">
    <style>
    html, body { height: 100%; margin: 0; }
    #map { position: absolute; top: 0; bottom: 0; left: 0; right: 0; }
    .icon { max-width: 70%; max-height: 70%; margin: 4px; }

    /* Info panel table styling */
    #info-panel table { 
        width: 100%; 
        border-collapse: collapse; 
        font-family: Arial, sans-serif;
        font-size: 13px;
        line-height: 1.4;
        color: #333;
    }
    #info-panel th, #info-panel td {
        padding: 6px;
        border: 1px solid #ddd;
    }
    #info-panel th { 
        background-color: #f7f7f7; 
        font-weight: bold; 
        text-align: left; 
        width: 40%; 
    }
    #info-panel td { background-color: #ffffff; }

    /* Legend styling */
    .legend { background: white; padding: 8px; border-radius: 4px; box-shadow: 0 0 6px rgba(0,0,0,0.2); }
    .legend .item { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
    .legend .swatch { width: 18px; height: 14px; border: 1px solid #ccc; }

    /* Label styling */
    #label {
        font-family: Cambria, Cochin, Georgia, Times, 'Times New Roman', serif;
        font-size: 20pt;
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(255, 255, 255, 1);
        padding: 5px;
        border-radius: 5px;
        z-index: 1000;
    }

    /* Logo styling for responsiveness */
    .logo {
        background-color: rgba(255, 255, 255, 1);
        position: absolute;
        top: 10px;
        z-index: 2000;
        width: 8vw;         /* 8% of viewport width */
        max-width: 90px;     /* maximum width */
        min-width: 50px;     /* minimum width */
        height: auto;        /* maintain aspect ratio */
    }
    #logo-left { left: 100px; }
    #logo-right { right: 200px; }
    </style>
</head>
<body>
    <div id="map"></div>

    <div id="label">WEBGIS RENTANG IRRIGATION MODERNIZATION PROJECT</div>

    <img id="logo-left" class="logo" src="pupr.png" alt="Left Logo">
    <img id="logo-right" class="logo" src="nippon.png" alt="Right Logo">

    <div id="info-panel" style="
        position:absolute;
        bottom:20px;
        left:20px;
        width:300px;
        background:white;
        padding:10px;
        border-radius:6px;
        z-index:3000;">
        Click a feature to see info
    </div>
    <div id="dashboard" style="
        position:absolute;
        top:330px;
        right:10px;
        z-index:4000;
        width:260px;
        background:white;
        padding:10px;
        border-radius:6px;
        font-family:Arial, sans-serif;
        font-size:12px;
        box-shadow:0 0 6px rgba(0,0,0,0.25);
    ">
        <strong>Monitoring Dashboard</strong>
        <hr style="margin:6px 0">

        <div><strong>Left Bank Area</strong></div>
        <div id="stat-des-appr"></div>

        <hr style="margin:6px 0">

        <div><strong>Construction Status</strong></div>
        <div id="stat-cons-stat"></div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script src="https://unpkg.com/togeojson@0.14.2"></script>
    <script src="https://cdn.jsdelivr.net/gh/makinacorpus/Leaflet.FileLayer/leaflet.filelayer.js"></script>
    <script src="Tblock.js"></script>
    <script src="Structures.js"></script>
    <script src="Tcanal.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>

    <script>
    // Map initialization
    var map = L.map('map').setView([-6.493053513471269, 108.31170522048976], 11);

    // Highlight helpers
    var lastHighlight = null;
    function highlightFeature(e) {
        var layer = e.target;
        if (!layer._originalStyle && layer.setStyle) {
            layer._originalStyle = {
                color: layer.options.color,
                weight: layer.options.weight,
                fillColor: layer.options.fillColor,
                fillOpacity: layer.options.fillOpacity
            };
        }

        if (layer.feature && layer.feature.geometry && 
            (layer.feature.geometry.type === 'LineString' || layer.feature.geometry.type === 'MultiLineString')) {
            if (layer.setStyle) layer.setStyle({ color: '#ffff00', weight: (layer._originalStyle && layer._originalStyle.weight ? layer._originalStyle.weight + 1 : 3) });
        } else {
            if (layer.setStyle) layer.setStyle({ fillColor: '#ffff00', fillOpacity: 1 });
        }
        lastHighlight = layer;
    }
    function resetHighlight(e) {
        var layer = e.target || lastHighlight;
        if (!layer) return;
        if (layer.setStyle && layer._originalStyle) {
            layer.setStyle(layer._originalStyle);
        }
        lastHighlight = null;
    }

    // Utility to remove empty rows
    function removeEmptyRowsFromPopupContent(content, feature) {
        var tempDiv = document.createElement('div');
        tempDiv.innerHTML = content;
        var rows = tempDiv.querySelectorAll('tr');
        for (var i = rows.length - 1; i >= 0; i--) {
            var td = rows[i].querySelector('td');
            if (!td) continue;
            var text = td.textContent || '';
            if (text.trim() === '' || text === 'null' || text === 'undefined') {
                rows[i].parentNode.removeChild(rows[i]);
            }
        }
        return tempDiv.innerHTML;
    }

    // ---------- Popup functions converted to static info panel ----------
    function pop_Tblock(feature, layer) {
        layer.on({
            click: function () {
                let p = feature.properties;
                document.getElementById("info-panel").innerHTML = `
                <table>
                    <tr><th>Bank</th><td>${p.BANK ?? ''}</td></tr>
                    <tr><th>Canal Name</th><td>${p.CANAL ?? ''}</td></tr>
                    <tr><th>Packages</th><td>${p.PACKAGES ?? ''}</td></tr>
                    <tr><th>Block Name</th><td>${p.TB_NAME ?? ''}</td></tr>
                    <tr><th>Approval</th><td>${p.DES_APPR ?? ''}</td></tr>
                    <tr><th>Area</th><td>${p.AREA_HA ?? ''} Ha</td></tr>
                    <tr><th>Construction</th><td>${p.CONS_STAT ?? ''}</td></tr>
                    <tr><th>Construction Type</th><td>${p.CONS_TYPE ?? ''}</td></tr>
                    <tr><th>Desa</th><td>${p.VILLAGE ?? ''}</td></tr>
                    <tr><th>Kecamatan</th><td>${p.SUB_DIST ?? ''}</td></tr>
                    <tr><th>Kota/Kab</th><td>${p.DISTRICT ?? ''}</td></tr>
                    <tr><th>Contractor</th><td>${p.CONTRACTOR ?? ''}</td></tr>
                </table>`;
                highlightFeature({target: layer});
            },
            mouseover: highlightFeature,
            mouseout: resetHighlight
        });
    }

    function pop_Box(feature, layer) {
        layer.on({
            click: function () {
                let p = feature.properties;
                document.getElementById("info-panel").innerHTML = `
                <table>
                    <tr><th>Key</th><td>${p.Key ?? ''}</td></tr>
                    <tr><th>Tertiary Block</th><td>${p.Nama_block ?? ''}</td></tr>
                    <tr><th>Nama Box</th><td>${p.Nama_Box ?? ''}</td></tr>
                </table>`;
                highlightFeature({target: layer});
            },
            mouseover: highlightFeature,
            mouseout: resetHighlight
        });
    }

    function pop_Tertiary(feature, layer) {
        layer.on({
            click: function () {
                let p = feature.properties;
                document.getElementById("info-panel").innerHTML = `
                <table>
                    <tr><th>Section</th><td>${p.Con_Name ?? ''}</td></tr>
                    <tr><th>Length</th><td>${p.Length ?? ''} m</td></tr>
                    <tr><th>Type</th><td>${p.canal_type ?? ''}</td></tr>
                    <tr><th>Tertiary Block</th><td>${p.Nama_block ?? ''}</td></tr>
                </table>`;
                highlightFeature({target: layer});
            },
            mouseover: highlightFeature,
            mouseout: resetHighlight
        });
    }

    // ---------- Styles ----------
    function style_tblock(feature) {
        var att = feature.properties || {};
        var type = att.CONS_TYPE;
        var color = 'black', fill_color = 'black', fill_opacity = 0.4;

        switch (att.CONS_STAT) {
          case 'District Authority': color = '#973C08'; fill_color = '#973C08'; break;
          case 'MDA': color = '#432DD7'; fill_color = '#432DD7'; break;
          case 'No Construction': color = '#E7180B'; fill_color = '#E7180B'; break;
          case 'Not Yet Started':
            if (type === 'Precast') { color = '#58E625'; fill_color = '#58E625'; }
            else if (type === 'Insitu') { color = '#E6A225'; fill_color = '#E6A225'; } 
            break;
          case 'Remaining': color = '#F1F5F9'; fill_color = '#F1F5F9'; break;
          case 'Under Construction':
            if (type === 'Precast') { color = '#46ECD5'; fill_color = '#46ECD5'; }
            else if (type === 'Insitu') { color = '#FFF085'; fill_color = '#FFF085'; }
            break;
        }
        return { color: color, fillColor: fill_color, fillOpacity: fill_opacity, weight: 1 };
    }

    function style_box(feature) {
        var att = feature.properties || {};
        var style = { radius: 6, fillOpacity: 0.9, weight: 1, color: '#333', fillColor: '#ff7800' };
        switch (att.LAYER) {
            case 'Box Tersier': style.color = 'brown'; style.fillColor = 'brown'; break;
            case 'Box Kuarter': style.color = 'blue'; style.fillColor = 'blue'; break;
            case 'Box Division': style.color = 'red'; style.fillColor = 'red'; break;
            case 'Culvert': style.color = 'purple'; style.fillColor = 'purple'; break;
        }
        return style;
    }

    function style_tertiary(feature) {
        var att = feature.properties || {};
        var color = '#0077be';
        switch (att.Connection) {
        case 'OT-T': color = '#2a7ad6'; break;
        case 'OT-K': color = '#43f17a'; break;
        case 'T-T': color = '#6f2ed8'; break;
        case 'T-K': color = '#54d7ab'; break;
        case 'K-END': color = '#88170b'; break;
        }
        return { color: color, weight: 2 };
    }

    // ---------- Layers ----------
    var Tblock = L.geoJSON(typeof Tblock !== 'undefined' ? Tblock : [], { style: style_tblock, onEachFeature: pop_Tblock }).addTo(map);
    var boxLayer = L.geoJSON(typeof boxLayer !== 'undefined' ? boxLayer : [], {
        pointToLayer: function(feature, latlng) { return L.circleMarker(latlng, style_box(feature)); },
        onEachFeature: pop_Box
    }).addTo(map);
    var tertiaryLayer = L.geoJSON(typeof tertiaryLayer !== 'undefined' ? tertiaryLayer : [], { style: style_tertiary, onEachFeature: pop_Tertiary }).addTo(map);

    // ---------- Basemaps ----------
    var maptiler = L.tileLayer('https://api.maptiler.com/maps/hybrid/{z}/{x}/{y}.jpg?key=W6d5CfR5JVewAHeVqQzP', { attribution: '<a href="https://www.maptiler.com/copyright/" target="_blank">&copy; MapTiler</a> <a href="https://www.openstreetmap.org/copyright" target="_blank">&copy; OpenStreetMap contributors</a>' }).addTo(map);
    var esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles &copy; Esri' });
    var osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap contributors' });
    var darkmap = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { subdomains: 'abcd', maxZoom: 20 });
    var basemaps = { 'Satellite Imagery': maptiler, 'Open Street Map': osm, 'ESRI World Imagery': esri, 'Carto Dark Map': darkmap };
    var overlays = { 'Tertiary Blocks': Tblock, 'Structures': boxLayer, 'Tertiary Canals': tertiaryLayer };
    L.control.layers(basemaps, overlays, { collapsed: false }).addTo(map);

    // ---------- Center Map Control Button ----------
    var CenterControl = L.Control.extend({
        options: {
            position: 'topleft' // Position the button
        },

        onAdd: function (map) {
            var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
            container.style.backgroundColor = 'white';
            container.style.width = '30px';
            container.style.height = '30px';
            container.style.lineHeight = '30px';
            container.style.textAlign = 'center';
            container.title = 'Zoom to Full Extent';
            container.innerHTML = `
                <div style="
                display: flex;
                align-items: center;
                justify-content: center;
                width: 100%;
                height: 100%;
            ">
                <img src="center.png" style="
                width: 20px;
                height: 20px;
                ">`;

            container.onclick = function(){
                fitToAllLayers();
            }

            return container;
        }
    });
    map.addControl(new CenterControl());
    // ---------- Legend ----------
    var legend = L.control({ position: 'bottomright' });
    legend.onAdd = function(map) {
        var div = L.DomUtil.create('div', 'legend');
        div.innerHTML += '<strong>Legend</strong><br/>';
        var items = [
            ['District Authority', '#973C08'],
            ['MDA', '#432DD7'],
            ['No Construction', '#E7180B'],
            ['Ready - Precast', '#58E625'],
            ['Ready - Insitu', '#E6A225'],
            ['Remaining', '#F1F5F9'],
            ['Under Construction - Precast', '#46ECD5'],
            ['Under Construction - Insitu', '#FFF085']
        ];
        items.forEach(function(it){
            div.innerHTML += '<div class="item"><div class="swatch" style="background:'+it[1]+'"></div><div>'+it[0]+'</div></div>';
        });
        return div;
    };
    legend.addTo(map);

    // ---------- FileLayer Upload ----------
    var fileLayerStyle = { color: 'red', opacity: 1.0, fillOpacity: 0.6, weight: 2, interactive: false };
    L.Control.FileLayerLoad.LABEL = '<img class="icon" src="https://static.thenounproject.com/png/folder-icon-652750-512.png" alt="file icon"/>';
    var fileLayerControl = L.Control.fileLayerLoad({ fitBounds: true, layerOptions: { style: fileLayerStyle, pointToLayer: function (data, latlng) { return L.circleMarker(latlng, fileLayerStyle); } } });
    fileLayerControl.addTo(map);
    fileLayerControl.loader.on('data:loaded', function (e) { console.log('Loaded layer:', e.layer); });

    // ---------- Fit map to visible data bounds ----------
    function fitToAllLayers() {
        var group = L.featureGroup();
        [Tblock, boxLayer, tertiaryLayer].forEach(function(l){ if (l && l.getBounds && l.getBounds().isValid && l.getBounds().isValid()) { try { group.addLayer(l); } catch(e){} } });
        try { var b = group.getBounds(); if (b && b.isValid()) map.fitBounds(b); } catch(e) {}
    }
    setTimeout(fitToAllLayers, 800);
    // ---------- Filter by PACKAGES ----------
document.getElementById("packageFilter").addEventListener("change", function () {
    var selected = this.value;
    //---------- Tblock ----------
    Tblock.eachLayer(function (layer) {
        var pkg = layer.feature.properties.PACKAGES;
        var show = (selected === "ALL" || pkg === selected);

        layer.setStyle({
            opacity: show ? 1 : 0,
            fillOpacity: show ? 0.4 : 0
        });
    });
    // ---------- Structures ----------
    boxLayer.eachLayer(function (layer) {
        var pkg = layer.feature.properties.Packages;
        var show = (selected === "ALL" || pkg === selected);

        layer.setStyle({
            opacity: show ? 1 : 0,
            fillOpacity: show ? 0.9 : 0
        });
    });
    // ---------- Tcanal ----------
    tertiaryLayer.eachLayer(function (layer) {
        var pkg = layer.feature.properties.Packages;
        var show = (selected === "ALL" || pkg === selected);

        layer.setStyle({
            opacity: show ? 1 : 0
        });
    });

    // ðŸ”¹ Update dashboard
    updateDashboard(selected);
});
// ---------- Dashboard Counter ----------
function updateDashboard(selectedPackage = "ALL") {
    var areaTotal = 0;
    var lengthTotal = 0;

    var areaByCan = {};
    var lengthByCan = {};

    var consStatCount = {};

    Tblock.eachLayer(function (layer) {
        var p = layer.feature.properties;

        // Skip if package does not match
        if (selectedPackage !== "ALL" && p.PACKAGES !== selectedPackage) return;

        var area = parseFloat(p.AREA_HA) || 0;
        var length = (parseFloat(p.LENGTH_M) || 0) / 1000;

        areaTotal += area;
        lengthTotal += length;

        // Group by CANAL when a specific package is selected
        if (selectedPackage !== "ALL") {
            var can = p.CANAL || "Unknown";

            areaByCan[can] = (areaByCan[can] || 0) + area;
            lengthByCan[can] = (lengthByCan[can] || 0) + length;
        }

        // CONS_STAT always counted
        var stat = p.CONS_STAT || "Unknown";
        consStatCount[stat] = (consStatCount[stat] || 0) + 1;
    });

    /* ---------- Render AREA + LENGTH ---------- */
    var html = "";

    if (selectedPackage === "ALL") {
        html = `
            <div><strong>Total Area:</strong> ${areaTotal.toFixed(2)} Ha</div>
            <div><strong>Total Length:</strong> ${lengthTotal.toFixed(2)} Km</div>
        `;
    } else {
        for (var k in areaByCan) {
            html += `
                <div>
                    <strong>${k}</strong><br>
                    Area: ${areaByCan[k].toFixed(2)} Ha<br>
                    Length: ${lengthByCan[k].toFixed(2)} Km
                </div>
                <hr style="margin:4px 0">
            `;
        }
    }

    document.getElementById("stat-des-appr").innerHTML = html || "-";

    /* ---------- Render Construction Status ---------- */
    var statHtml = "";
    for (var k in consStatCount) {
        statHtml += `<div>${k}: <strong>${consStatCount[k]}</strong></div>`;
    }
    document.getElementById("stat-cons-stat").innerHTML = statHtml || "-";
}

    // Initial load
    updateDashboard();

    </script>
</body>
</html>
